import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.discriminant_analysis import LinearDiscriminantAnalysis
from sklearn import preprocessing
from sklearn.decomposition import PCA
import scipy as sp
import scipy.linalg as la

#Δημιουργία DataFrame με τα δεδομένα μας
data = pd.read_csv('winequality-white.csv', sep=";",header = 'infer')

#Επιλογή threshold
threshold = data.quality.median()
smaller = len(data.quality.loc[data.quality < threshold])
greater = len(data.quality.loc[data.quality > threshold])

print(threshold,smaller,greater)

#Δημιουργία Κλάσεων: 0 - Βαθμολογία<6, 1 - Βαθμολογία>=6
data['binQuality'] = [int(i>=threshold) for i in list(data.quality)]

#Δημιουργία Training και Test Set
trSet = (data.loc[data.binQuality == 0]).sample(frac=0.75)
data.drop(trSet.index,inplace=True)
temp = (data.loc[data.binQuality == 1]).sample(n=len(trSet))
trSet = pd.concat([trSet,temp])
testSet = data.loc[data.binQuality == 0]
temp = (data.loc[data.binQuality == 1]).sample(n=len(testSet))
testSet = pd.concat([testSet,temp])

#Επαναπροσδιορισμός Indexes για ευκολία στη χρήση
trSet = trSet.set_index(np.arange(len(trSet)))
testSet = testSet.set_index(np.arange(len(testSet)))

#Προπαρασκευή Δεδομένων
trSet.loc[trSet.binQuality==1].iloc[:,:11].plot(kind='hist',bins = 40, subplots = True,layout = (3,4), figsize = (30,20), sharex = True,title = "Excellent Quality")
trSet.loc[trSet.binQuality==0].iloc[:,:11].plot(kind='hist',bins = 40, subplots = True,layout = (3,4), figsize = (30,20), sharex = True,title = "Poor Quality")

for j in list(trSet)[:-2]:
    #Αφαίρεση ακραίων τιμών
    m_e=(trSet.loc[trSet.binQuality == 1])[j].mean()
    m_p=(trSet.loc[trSet.binQuality == 0])[j].mean()
    std_e=(trSet.loc[trSet.binQuality == 1])[j].std()
    std_p=(trSet.loc[trSet.binQuality == 0])[j].std()
    trSet.drop((trSet.loc[trSet.binQuality == 1]).loc[abs((trSet[j]-m_e))>(5*(std_e))].index,inplace = True)
    trSet.drop((trSet.loc[trSet.binQuality == 0]).loc[abs((trSet[j]-m_p))>(5*(std_p))].index,inplace = True)
    
nindex = np.arange(len(trSet.index))
trSet = trSet.set_index(nindex)

#Απεικόνιση συνόλου εκπαίδευσης
fig, axis = plt.subplots(6,2,figsize=(40,70))
x,y=(0,0)
for i in list(trSet)[:-2]:
    sns.kdeplot(trSet.loc[trSet.binQuality == 1][i],shade=True,ax=axis[x,y])
    ax = sns.kdeplot(trSet.loc[trSet.binQuality == 0][i],shade=True,ax=axis[x,y])
    ax.set_title('Κατανομή χαρακτηριστικού ' +i);
    y+=1
    if(y%2==0):
        y=0
        x+=1
        
#Correlation Matrices
cor_mat = trSet.loc[trSet.binQuality == 1].corr()
fig, ax=plt.subplots(figsize=(10,10))
ax = sns.heatmap(cor_mat,annot=True,ax=ax)
ax.set(title='Excellent Quality')
plt.show()

cor_mat = trSet.loc[trSet.binQuality == 0].corr()
fig, ax=plt.subplots(figsize=(10,10))
ax = sns.heatmap(cor_mat,annot=True,ax=ax)
ax.set(title='Poor Quality')
plt.show()

#Κανονικοποίηση
scaler = preprocessing.StandardScaler().fit(trSet.iloc[:,:-2])
train_scaled = scaler.transform(trSet.iloc[:,:-2])
test_scaled = scaler.transform(testSet.iloc[:,:-2])

#Ανάλυση PCA
pca = PCA().fit(train_scaled)
print(pca.explained_variance_)
print([list(trSet)[np.abs(pca.components_[i]).argmax()] for i in range(11)])

plt.plot(np.cumsum(pca.explained_variance_ratio_))
plt.xlabel('number of components')
plt.ylabel('cumulative explained variance');
plt.show()

pca = PCA(n_components=4)

trainPCA = pca.fit_transform(train_scaled)
testPCA = pca.transform(test_scaled)

#Κατανομή ιδιοτιμών πίνακα διασποράς
covMatrix = pd.DataFrame(train_scaled).cov()

import scipy as sp
import scipy.linalg as la

res = la.eig(covMatrix)
eigenValues = [i.real for i in res[0]]
eigenVectors = [i.real for i in res[1]]
plt.bar([list(trSet.iloc[:,:-2])[eigenValues.index(i)] for i in sorted(eigenValues, reverse = True) ],sorted(eigenValues, reverse = True))
plt.xticks(rotation=90)
plt.xlabel("Eigenvalue Index")
plt.ylabel("Eigenvalue")
plt.show()
########PROBLHMA PCA - PC != MEGALUTERES IDIOTIMES#######################################################

#Βελτιστοποίηση παραμέτρων
score = []
for i in range(1,10):
    r = 10**(-i)
    clf_LDA = LinearDiscriminantAnalysis(solver="lsqr",shrinkage=r)
    clf_LDA.fit(trSet.iloc[:,:-2],trSet.binQuality)
    score.append(clf_LDA.score(trSet.iloc[:,:-2],trSet.binQuality))
    
r = 10**(-score.index(max(score))-1)

#Γραμμικός Ταξινομητής Ελαχίστων Τετραγώνων
clf_LDA = LinearDiscriminantAnalysis(solver="lsqr",shrinkage=r)
clf_LDA.fit(trSet.iloc[:,:-2],trSet.binQuality)

W_LDA = clf_LDA.coef_[0]
W0_LDA = clf_LDA.intercept_

print("===== LDA WEIGHTS =======")
print("W = ",W_LDA)
print("W0 = ",W0_LDA)
print("Normalized W = ",W_LDA/W_LDA[0])
print("Normalized W0 = ",W0_LDA/W_LDA[0])
